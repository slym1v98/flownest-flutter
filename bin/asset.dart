import 'dart:io';
import 'package:kappa/cli/commander.dart';
import 'package:path/path.dart' as p;

Future<void> main(List<String> args) async {
  await Commander.info('---------------- Generating Asset Constants ------------------');

  final assetsDir = Directory('assets');
  if (!assetsDir.existsSync()) {
    assetsDir.createSync();
    await Commander.info('Created assets/ directory.');
  }

  final List<String> assetPaths = [];
  _collectAssets(assetsDir, assetPaths);

  final buffer = StringBuffer();
  buffer.writeln('// Generated by Kappa CLI. Do not manually edit.');
  buffer.writeln('class AppAssets {');
  buffer.writeln('  AppAssets._();');
  buffer.writeln();

  for (var path in assetPaths) {
    final fileName = p.basenameWithoutExtension(path);
    final extension = p.extension(path).replaceAll('.', '');
    final variableName = _toCamelCase(fileName);
    final fullPath = path.replaceAll('', '/');
    
    buffer.writeln('  /// Path for $fullPath');
    buffer.writeln("  static const String $variableName = '$fullPath';");
  }

  buffer.writeln('}');

  final outputFile = File('lib/src/core/resources/app_assets.dart');
  if (!outputFile.parent.existsSync()) {
    outputFile.parent.createSync(recursive: true);
  }
  
  await outputFile.writeAsString(buffer.toString());
  await Commander.info('Successfully generated: lib/src/core/resources/app_assets.dart');
}

void _collectAssets(Directory dir, List<String> paths) {
  final List<FileSystemEntity> entities = dir.listSync();
  for (var entity in entities) {
    if (entity is File) {
      // Ignore hidden files
      if (!p.basename(entity.path).startsWith('.')) {
        paths.add(entity.path);
      }
    } else if (entity is Directory) {
      _collectAssets(entity, paths);
    }
  }
}

String _toCamelCase(String text) {
  text = text.replaceAll(RegExp(r'[^a-zA-Z0-9]'), '_');
  final parts = text.split('_');
  if (parts.isEmpty) return '';
  
  String result = parts[0].toLowerCase();
  for (int i = 1; i < parts.length; i++) {
    if (parts[i].isNotEmpty) {
      result += parts[i][0].toUpperCase() + parts[i].substring(1).toLowerCase();
    }
  }
  return result;
}
